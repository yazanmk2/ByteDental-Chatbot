name: Deploy

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Deploy to production server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e

            echo "=== Starting deployment ==="
            cd /opt/senior-dental-ai-chatbot

            echo "=== Pulling latest code ==="
            git fetch origin main
            git reset --hard origin/main

            echo "=== Activating virtual environment ==="
            source venv/bin/activate

            echo "=== Installing dependencies ==="
            pip install -r requirements.txt --quiet

            echo "=== Downloading model if needed ==="
            if [ ! -f "/opt/senior-dental-ai-chatbot/models/qwen2.5-3b-instruct-q4_k_m.gguf" ]; then
              echo "Model not found, downloading Qwen2.5-3B-Instruct..."
              bash scripts/download_model.sh
            else
              echo "Model already exists, skipping download"
            fi

            echo "=== Restarting service ==="
            sudo systemctl restart bytedent-chatbot

            echo "=== Waiting for service to start ==="
            sleep 10

            echo "=== Health check ==="
            for i in {1..6}; do
              if curl -sf http://localhost:8001/api/v1/health/ready > /dev/null; then
                echo "Health check passed!"
                break
              fi
              if [ $i -eq 6 ]; then
                echo "Health check failed after 6 attempts"
                sudo journalctl -u bytedent-chatbot --no-pager -n 50
                exit 1
              fi
              echo "Waiting for service... (attempt $i/6)"
              sleep 5
            done

            echo "=== Deployment successful! ==="
